// Battery Managment System (BMS) Software /////////////////////////////////////////
//
// Created for 2019 Rover by: Jacob Lipina, jrlwd5
//
//
// Libraries ///////////////////////////////////////////////////////////////////////
// 
// Standard C
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>

// Energia
#include <SPI.h>
#include <Ethernet.h>
#include <EthernetUdp.h>

// RoveWare
#include <RoveBoard.h>
#include <RoveEthernet.h>
#include <RoveComm.h>

// RoveComm DataIDs /////////////////////////////////////////////////////////////////
//
// Commands
const uint32_t SW_ESTOP						= 2000; // [delay] (ms, 0-off until reboot)
const uint32_t FAN_EN						= 2001; // [Fan1, Fan2, Fan3, Fan4] (0-Fan Disable, 1-Fan Enable)
const uint32_t BUZZER_EN					= 2002; //

// Telemetry
const uint32_t I_MEAS						= 2100; // [Main] (mA)
const uint32_t V_MEAS						= 2101; // [Pack_Out, Logic, C1-G, C2-1, C3-2, C4-3, C5-4, C6-5, C7-6, C8-7] (mV)
const uint32_t TEMP_MEAS					= 2102; // [Temp] (mdegC)

const uint16_t NO_ROVECOMM_MESSAGE          = 0; // RED can toggle the bus by bool
const int ROVECOMM_DELAY 					= 10;

//Rovecomm :: RED packet :: data_id and data_value with number of data bytes size
uint16_t data_id       = 0;
size_t   data_size     = 0; 
uint8_t  data_value    = 0;

// Pinmap //////////////////////////////////////////////////////////////////////////
//
// Control Pins
const int PACK_OUT_CTR 						= PD_1;
const int PACK_OUT_IND 						= PQ_2;
const int LOGIC_SWITCH_CTR					= PD_0;
const int BUZZER_CTR						= PN_2;
const int FAN_1_CTR							= PH_2;
const int FAN_2_CTR							= PH_3;
const int FAN_3_CTR							= PL_5;
const int FAN_4_CTR							= PL_4;
const int FAN_PWR_IND						= PF_1;
const int SW_IND							= PQ_3;
const int SW_ERR							= PP_3;

// Sensor Volts/Amps Readings Pins
const int PACK_I_MEAS						= PE_0;
const int PACK_V_MEAS						= PE_1;
const int LOG_V_MEAS						= PE_2;
const int TEMP_D_MEAS						= PM_3;
const int C1-GND_MEAS						= PK_3;
const int C2-C1_MEAS						= PK_2;
const int C3-C2_MEAS						= PK_1;
const int C4-C3_MEAS						= PK_0;
const int C5-C4_MEAS						= PB_5;
const int C6-C5_MEAS						= PB_4;
const int C7-C6_MEAS						= PD_5;
const int C8-C7_MEAS						= PD_4;

// Constants and Calculations for Sensor Measurments ////////////////////////////////////////////////
//
// Tiva1294C RoveBoard Specs
const float VCC                 = 3.3;       //volts
const float ADC_MAX             = 4096;      //bits
const float ADC_MIN             = 0;         //bits
const int IDLE_SHUTOFF_MINS		= 30;
float adc_reading = 0;

// ACS759ECB-200B-PFF-T Current Sensor Specs
	// Find at: https://www.digikey.com/products/en?keywords=%20620-1466-5-ND%20
const float SENSOR_SENSITIVITY   = 0.0066;    //volts/amp
const float SENSOR_SCALE = 0.5;
const float SENSOR_BIAS = VCC * SENSOR_SCALE;  //Viout voltage when current is at 0A (aka quiescent output voltage)
	// Noise is 2mV, meaning the smallest current that the device is able to resolve is 0.3A
const float CURRENT_MAX          = (VCC - SENSOR_BIAS - 0.33) / SENSOR_SENSITIVITY; // Amps
const float CURRENT_MIN          = -(SENSOR_BIAS - 0.33) / SENSOR_SENSITIVITY; // Amps
const float OVERCURRENT			 = 180; //TODO: This value should be lower, but where?
float current_reading            = 0; //TODO: the calcs currently output a current as a float. What has to change to send to BS as an int. Is it simply mult by 1000?

// scales the input value x from analog input range (0 to 3.3) to actual values (Pack voltage or current)
float scale(float x, float in_min, float in_max, float out_min, float out_max)
{
  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}//end fnctn

// Voltage Measurments
const float VOLTS_MIN            = 0;
const float PACK_VOLTS_MAX       = 33.6; //This num may change as we test using hardware
const float CELL_VOLTS_MAX 		 = 4.2;
float voltage_reading            = 0;

const int DEBOUNCE_DELAY = 10;

adc_reading = analogRead(ACT_AMPS);
  current_reading = scale(adc_reading, ADC_MIN, ADC_MAX, CURRENT_MIN, CURRENT_MAX);
  roveComm_SendMsg(ACT_12V_CURRENT_READING, sizeof(current_reading), &current_reading);
  delay(ROVECOMM_DELAY);

adc_reading = analogRead(PACK_VOLTAGE);
  voltage_reading = scale(adc_reading, ADC_MIN, ADC_MAX, VOLTS_MIN, VOLTS_MAX);
  roveComm_SendMsg(PACK_VOLTAGE_READING, sizeof(voltage_reading), &voltage_reading);
  delay(ROVECOMM_DELAY);

// DS18B20 Temp Sensor Specs 
	//Find at: https://www.digikey.com/product-detail/en/maxim-integrated/DS18B20/DS18B20-ND/420071
const float  

